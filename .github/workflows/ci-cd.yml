name: CodeMate Mobile CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ
    - cron: '0 2 * * *'

env:
  JAVA_VERSION: '17'
  ANDROID_COMPILE_SDK: '34'
  ANDROID_BUILD_TOOLS_VERSION: '34.0.0'
  ANDROID_SDK_TOOLS: '10406996'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: è®¾ç½®Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_COMPILE_SDK }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}

      - name: ç¼“å­˜Gradleä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: å®‰è£…Detekt
        run: |
          curl -sS "https://github.com/detekt/detekt/releases/latest/download/detekt" \
            -L -o detekt && \
          chmod +x detekt

      - name: è¿è¡ŒDetekté™æ€åˆ†æ
        run: ./detekt --input . --report xml:detekt-report.xml || true

      - name: å®‰è£…ktlint
        run: |
          curl -sS "https://github.com/pinterest/ktlint/releases/latest/download/ktlint" \
            -L -o ktlint && \
          chmod +x ktlint

      - name: è¿è¡Œktlintä»£ç é£æ ¼æ£€æŸ¥
        run: ./ktlint --reporter xml --output ./ktlint-report.xml || true

      - name: ä¸Šä¼ ä»£ç è´¨é‡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-reports
          path: |
            detekt-report.xml
            ktlint-report.xml

  # å•å…ƒæµ‹è¯•
  unit-tests:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: è®¾ç½®Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_COMPILE_SDK }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}

      - name: ç¼“å­˜Gradleä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: ./gradlew test

      - name: ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
        run: ./gradlew jacocoTestReport

      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            app/build/reports/tests/testDebugUnitTest/
            app/build/reports/jacoco/

  # æ„å»ºDebug APK
  build-debug:
    name: æ„å»ºDebug APK
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: è®¾ç½®Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_COMPILE_SDK }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}

      - name: ç¼“å­˜Gradleä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: æ„å»ºDebug APK
        run: ./gradlew assembleDebug

      - name: ä¸Šä¼ Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk

  # æ„å»ºRelease APK
  build-release:
    name: æ„å»ºRelease APK
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: è®¾ç½®Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_COMPILE_SDK }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}

      - name: ç¼“å­˜Gradleä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: æ„å»ºRelease APK
        run: ./gradlew assembleRelease

      - name: ä¸Šä¼ Release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: app/build/outputs/apk/release/app-release.apk

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: é›†æˆæµ‹è¯•
    runs-on: macos-latest
    needs: [build-debug]
    if: github.event_name == 'pull_request'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: è®¾ç½®Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_COMPILE_SDK }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}

      - name: å¯åŠ¨Androidæ¨¡æ‹Ÿå™¨
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: google_apis
          arch: x86_64
          profile: pixel_4
          script: adb shell input keyevent 82

      - name: ç­‰å¾…æ¨¡æ‹Ÿå™¨å¯åŠ¨
        run: adb wait-for-device && adb shell input keyevent 82

      - name: å®‰è£…Debug APK
        run: adb install app/build/outputs/apk/debug/app-debug.apk

      - name: è¿è¡Œé›†æˆæµ‹è¯•
        run: ./gradlew connectedAndroidTest

      - name: ä¸Šä¼ é›†æˆæµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-reports
          path: app/build/reports/androidTests/connected/

  # å®‰å…¨æ‰«æ
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: [build-debug]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½Debug APK
        uses: actions/download-artifact@v4
        with:
          name: app-debug-apk
          path: app-debug.apk

      - name: è¿è¡ŒMobSFé™æ€åˆ†æ
        uses: ajaybathini/mobile-security-framework-mobsf@master
        with:
          api_key: ${{ secrets.MOBSF_API_KEY }}
          file: app-debug.apk

  # SonarQubeæ‰«æ
  sonar-scan:
    name: SonarQubeæ‰«æ
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: github.event_name == 'pull_request'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: è¿è¡ŒSonarQubeåˆ†æ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          ./gradlew sonarqube \
            -Dsonar.projectKey=codemate-mobile \
            -Dsonar.organization=xzmaster54088 \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

  # éƒ¨ç½²
  deploy:
    name: éƒ¨ç½²
    runs-on: ubuntu-latest
    needs: [build-release, integration-tests, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½Release APK
        uses: actions/download-artifact@v4
        with:
          name: app-release-apk
          path: app-release.apk

      - name: éƒ¨ç½²åˆ°Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          groups: testers
          file: app-release.apk

      - name: åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.0-${{ github.sha }}
          name: CodeMate Mobile v1.0.0
          body: |
            ## ğŸ‰ CodeMate Mobile v1.0.0 Build
            
            **æ„å»ºä¿¡æ¯:**
            - Commit: ${{ github.sha }}
            - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            - æ„å»ºè€…: ${{ github.actor }}
            
            **ä¸»è¦æ›´æ–°:**
            - âœ… å®Œæ•´çš„AIç¼–ç¨‹åŠ©æ‰‹åŠŸèƒ½
            - âœ… æ™ºèƒ½ä»£ç ç¼–è¾‘å™¨
            - âœ… æœ¬åœ°ç¼–è¯‘å¼•æ“
            - âœ… GitHubé›†æˆ
            - âœ… ä¼ä¸šçº§å®‰å…¨ä¿æŠ¤
            
            **ä¸‹è½½é“¾æ¥:**
            - [APKä¸‹è½½](https://github.com/${{ github.repository }}/releases/download/v1.0.0-${{ github.sha }}/app-release.apk)
          files: app-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘é€éƒ¨ç½²é€šçŸ¥
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          message: |
            ğŸš€ CodeMate Mobileéƒ¨ç½²æˆåŠŸï¼
            
            **ç‰ˆæœ¬:** v1.0.0-${{ github.sha }}
            **åˆ†æ”¯:** ${{ github.ref_name }}
            **æ„å»ºè€…:** ${{ github.actor }}
            
            [æŸ¥çœ‹Release](https://github.com/${{ github.repository }}/releases)
        if: always()

  # ä»£ç è´¨é‡é—¨ç¦
  quality-gate:
    name: ä»£ç è´¨é‡é—¨ç¦
    runs-on: ubuntu-latest
    needs: [sonar-scan]
    if: github.event_name == 'pull_request'
    steps:
      - name: æ£€æŸ¥SonarQubeè´¨é‡é—¨ç¦
        uses: sonarqube-quality-gate-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}